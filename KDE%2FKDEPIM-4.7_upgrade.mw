This guide has been shamelessly copied from the [https://wiki.kubuntu.org/OneiricOcelot/Final/Kubuntu/Kmail2 Ubuntu Wiki]. Please improve and adapt it for Gentoo!

== Introduction ==
With KDEPIM-4.6 and 4.7, KDE's Personal Information Management suite, Kontact, has seen a major move to the new Akonadi system. This will mean any users of previous versions of of the PIM software will need to have their data migrated to the new system. This includes contacts from KAddressBook, events from KOrganizer, and email messages and accounts from KMail. Unfortunately, this process does not work automatically at this time, and may not be 100% successful when it is performed manually.

On the initial startup of the new KDE PIM suite, the address book and calendar data will be migrated automatically.

{{Warning|It is not really advisable yet to upgrade KDEPIM on laptops and other devices with an unstable internet connection, as the Akonadi backend tends to crash in these situations.}}

== Backing Up ==
The move to KMail2 means that email accounts and information are now also using Akonadi's storage and data system. The migration process for this will occur when KMail or Kontact is first run, and can be skipped for those who prefer to create their accounts manually. Unfortunately, at this time, the migration tool does not properly run when you select the Migrate option, see {{Bug|857828|site=launchpad}}

For this reason, it is highly advised that users back up their PIM data '''before''' running KMail after upgrading. It also may be advisable for some to skip the migration process and recreate their accounts from scratch.

To back up your data, make copies of these files and folders:
* <tt>~/.kde4/share/apps/kmail</tt> - This is where your emails are stored.
* <tt>~/Mail</tt> - Used by (very) old Kmail versions. (Still used when found).
* <tt>~/.kde4/share/apps/korganizer</tt> - Your calendar data is here.
* <tt>~/.kde4/share/apps/kabc</tt> - Contacts are kept here.
With these saved folders, it will be possible to import the data into Kontact should the need arise.

* <tt>~/.kde4/share/config/kmailrc</tt>
* <tt>~/.kde4/share/config/kaddressbookrc</tt>
* <tt>~/.kde4/share/config/korganizerrc</tt>
* <tt>~/.kde4/share/config/emailidentities</tt>
* <tt>~/.kde4/share/config/emaildefaults</tt>
* <tt>~/.kde4/share/config/kmailrc</tt>
* <tt>~/.kde4/share/config/mailtransports</tt>
These are the basic config files for the various Kontact applications.

More information on what you may want to back up can be found [http://userbase.kde.org/KMail/FAQs_Hints_and_Tips#Transfer_mail_and_settings_to_another_computer_.28or_another_user_account_on_the_same_machine.29 here], but with the folders listed above, you will be able to import things back into Kontact if necessary.

== Failed Migration ==
If you have already attempted to run the migrator and it failed, you can re-run it manually by first deleting your <tt>~/.kde4/share/config/kmail-migratorrc</tt> file and your <tt>~/.kde4/share/config/kmail2rc</tt> file. Then you will need to run the migrator manually by hitting Alt-F2, and entering the following:
{{Cmd|kmail-migrator --interactive}}
The program will run, and all your accounts and mails will be moved over to the Akonadi system. 

== After Migrating ==
When KMail2 opens, you will notice a few things:
* Your accounts will no longer have the personalized names you have assigned to them. You can edit these from KMail's accounts section under '''Settings → Configure Kmail'''.
* Email filters are not transferred.
* Spam Filtering does not automatically move mail to the selected spam folder.
* On some disconnected (cached) IMAP accounts, many error popups may occur, though the mail is updated properly. Switching off disconnected mode does not fix the issue, but deleting the account and recreating it as a normal IMAP account should clear the error messages. ({{Bug|872478|site=launchpad}}).
* Mail in your ''Local Folders'' (and others) may not appear initially. You may have to right-click on the Local Folders icon and select '''Update folder and it's subfolders''', or wait until Kmail refreshes itself.

== Importing Email Manually ==
If you choose to skip the migration and enter your account information manually, it is very easy to import your saved KMail folders.

Go to '''File → Import Messages'''. In the dialog that opens, select '''Import KMail Maildirs and Folder Structure''', and browse to where you backed up your <tt>~/.kde4/share/apps/kmail</tt> folder. Follow the prompts to finish the process. If you have mail folders in a different format than the standard Kmail Maildir, choose the appropriate option in the Import dialog.

If you need to import your calendar, you would go to Kontact's ''Calendar'' section, select '''File → Import → Import calendar''', and browse to where you saved your <tt>~/.kde4/share/apps/korganizer</tt> and select the <tt>std.ics</tt> file there, as well as any others you may have.

For contacts, the process is similar: go to ''Contacts'', then '''File → Import → Import vcard''' , and browse to where you saved <tt>~/.kde4/share/apps/kabc</tt>, and select <tt>std.vcf</tt>, as well as any other .vcf file you may have.

== Troubleshooting ==
* [http://userbase.kde.org/Akonadi_4.4/Troubleshooting Akonadi Troubleshooting]
* [http://alien.slackbook.org/blog/kmail-terminates-during-startup-with-failed-to-fetch-the-resource-collection/ kmail terminates during startup with “Failed to fetch the resource collection”]

== Downgrading to 4.4 again ==
If you have tried out KDEPIM-4.7 and decide that you'd rather go back to KDEPIM-4.4, well, be warned: in general, version downgrades are not supported and can lead to arbitrary chaos. Here's what I ([[User:Dilfridge dilfridge]]) did, no guarantees that this works. Basically you have to delete the entire KDEPIM configuration and start from scratch.
* Quit all KDEPIM applications
* Stop akonadi:
{{Cmd|akonadicontrol stop}}
* Get the [http://www.gentoo.org/proj/en/desktop/kde/kdepim-4.7-mask.txt mask file] and place it in your /etc/portage/package.mask
* Remove all KDEPIM applications the brutal way:
{{Cmd|emerge -aC akonadiconsole akregator blogilo kabcclient kaddressbook kalarm kdepim-common-libs kdepim-icons kdepim-l10n kdepim-kresources kdepim-meta kdepim-strigi-analyzer kdepim-runtime kdepim-wizards kjots kleopatra kmail knode knotes konsolekalendar kontact korganizer ktimetracker}}
* Remove all your KDEPIM files (configuration, '''mail data''', akonadi database) (either delete it or move it out of the way to import it later again, '''warning: loss of data'''):
** <tt>~/.config/akonadi/*</tt>
** <tt>~/.local/share/akonadi/*</tt>
** <tt>~/.kde4/share/apps/akregator</tt>
** <tt>~/.kde4/share/apps/blogilo</tt>
** <tt>~/.kde4/share/apps/kabc</tt>
** <tt>~/.kde4/share/apps/kcal</tt>
** <tt>~/.kde4/share/apps/kmail</tt>
** <tt>~/.kde4/share/apps/kmail2</tt>
** <tt>~/.kde4/share/apps/kjots</tt>
** <tt>~/.kde4/share/apps/kjotsmigrator</tt>
** <tt>~/.kde4/share/apps/knode</tt>
** <tt>~/.kde4/share/apps/knotes</tt>
** <tt>~/.kde4/share/apps/kontact</tt>
** <tt>~/.kde4/share/apps/korganizer</tt>
** <tt>~/.kde4/share/config/akonadi*</tt>
** <tt>~/.kde4/share/config/akregatorrc</tt>
** <tt>~/.kde4/share/config/blogilorc</tt>
** <tt>~/.kde4/share/config/emaildefaults</tt>
** <tt>~/.kde4/share/config/emailidentities</tt>
** <tt>~/.kde4/share/config/kaddressbookmigratorrc</tt>
** <tt>~/.kde4/share/config/kaddressbookrc</tt>
** <tt>~/.kde4/share/config/kjotsmigratorrc</tt>
** <tt>~/.kde4/share/config/kmail*</tt>
** <tt>~/.kde4/share/config/knoderc</tt>
** <tt>~/.kde4/share/config/kontact_summaryrc</tt>
** <tt>~/.kde4/share/config/kontactrc</tt>
** <tt>~/.kde4/share/config/korganizerrc</tt>
** <tt>~/.kde4/share/config/mailtransports</tt>
** <tt>~/.kde4/share/config/mailviewerrc</tt>
* Re-emerge all KDEPIM applications, now in version 4.4
{{Cmd|emerge -a kdepim-meta}}
* Better log out of KDE and back in again to make sure all traces of the old, new version are gone
* Start reconfiguring your stuff...

[[Category:Software]]
[[Category:Desktop]]
