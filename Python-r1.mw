{{Lowercase title}}

''python-r1'' is a new eclass for Python packages. The major goal is to provide a simpler (and more powerful at the same time) replacement for the old ''python.eclass'' which people have significant trouble maintaining.

The ''-r1'' eclass branch consists of the following eclasses:
* python-r1 — general-use Python package eclass,
* distutils-r1 — distutils build system wrapper.

== Information for users ==

=== Choice of Python implementations ===
The main difference for users is the way that Python implementations for packages being built are selected.

In python.eclass, the implementations to be built can be selected using custom ''USE_PYTHON'' variable in ''make.conf''. If unset, the implementation currently selected using ''eselect python'' is used.

In python-r1 (and python-distutils-ng) the implementation is controlled using USE_EXPAND variable ''PYTHON_TARGETS''. If unset, the Gentoo-wide default is used (currently it is Python 2.7).

The enabled implementation can be set like the following:
{{Code|Example PYTHON_TARGETS setup in make.conf|<pre>
PYTHON_TARGETS="python2_7 python3_2"
</pre>}}

== Information for ebuild developers ==

=== Uses for eclasses ===

The ''distutils-r1'' eclass should be used:
* in Python packages which use the distutils build system,
* in Python packages which use another build system which works similarly to distutils (respects EPYTHON, installs scripts with correct shebang).

The ''python-r1'' eclass should be used:
* in packages with optional Python parts,
* in Python packages which use a build system for which distutils-r1 is not suitable.

The main features of the eclasses are listed in the following table:

{| class="wikitable" style="text-align: center"
!
! python-r1
! distutils-r1
|-
| Python implementation USE flags ||colspan=2| <tt>IUSE</tt> & <tt>REQUIRED_USE</tt>
|-
| Python dependency || on request (<tt>${PYTHON_DEPS}</tt>) || always
|-
| Phase functions || none || <tt>src_prepare</tt>, <tt>src_configure</tt>, <tt>src_compile</tt>, <tt>src_test</tt>, <tt>src_install</tt>
|-
|}

=== Migrating distutils packages ===

The most common changes needing to be done when migrating ''distutils'' packages to ''distutils-r1'' are:

# replace <tt>PYTHON_DEPEND</tt> & <tt>RESTRICT_PYTHON_ABIS</tt> with <tt>PYTHON_COMPAT</tt> (inclusive list),
# remove <tt>SUPPORT_PYTHON_ABIS</tt> (always on),
# replace <tt>PYTHON_USE_WITH</tt> with <tt>PYTHON_REQ_USE</tt> (which follows USE dependency syntax),
# remove <tt>PYTHON_MODNAME</tt> (not needed),
# replace manual patching with <tt>PATCHES</tt> array (if desired),
# remove calls to <tt>epatch_user</tt> (done in <tt>distutils-r1_prepare_all()</tt>),
# replace <tt>python_execute_function</tt> with appropriate pseudo-phase functions where appropriate (e.g. <tt>python_test()</tt>) or with <tt>python_foreach_impl</tt> elsewhere,
# replace <tt>DISTUTILS_SRC_TEST</tt> with explicit <tt>python_test()</tt> function.

For example, the following preamble:

{{code|A random distutils preamble|<pre>
# python eclass cruft
PYTHON_DEPEND="*:2.6"
PYTHON_USE_WITH="readline sqlite"
PYTHON_MODNAME="IPython"
SUPPORT_PYTHON_ABIS="1"
RESTRICT_PYTHON_ABIS="2.5 *-jython *-pypy-*"
</pre>}}

would be replaced by:
{{code|The equivalent distutils-r1 preamble|<pre>
PYTHON_COMPAT=( python{2_6,2_7,3_1,3_2} )
PYTHON_REQ_USE='readline,sqlite'
</pre>}}
